(function(){var t;t=angular.module("0media.events",[]),t.controller("0media.events.main",["$scope","$interval","$timeout","$http","0media.events.map","0media.events.map-style"].concat(function(t,e,a,n,r,i){var o,s,l;return t.style="default",o=$("#zm-event .eventmap"),t.dim={width:0,height:0,wtype:"w-md",htype:"h-md",timelineHeight:300},s=function(){return t.$apply(function(){var e,a,n;return e=[o.width(),o.height()],a=e[0],n=e[1],e=t.dim,e.width=a,e.height=n,t.dim.wtype=480>=a?"w-mc":768>=a?"w-xs":991>=a?"w-sm":1199>=a?"w-md":"w-lg",t.dim.htype=240>=n?"h-mc":320>=n?"h-xs":480>=n?"h-sm":600>=n?"h-md":"h-lg",t.dim.timelineHeight={"h-mc":180,"h-xs":240,"h-sm":270,"h-md":300,"h-lg":300}[t.dim.htype]})},l={onAdd:function(t,e){var a;return a=$("#zm-event .bubbles")[0],a.parentNode.removeChild(a),e.appendChild(a)},draw:function(e,a){var n;return n=1<<a.getZoom()-7,t.events.map(function(t){var a;return t.x=(a=e.ll2p(t.lat,t.lng)).x,t.y=a.y,t.rate=n})}},t.reset=function(e){return null==e&&(e=!1),t.events.map(function(t,a){return t.fadeout=1,t.opacity=1,t.size=0,t.circle_opacity=0,t.bubble={},t.first=!1,e||(t.top=50*a+65),t})},t.setStyle=function(e){return t.style=e,t.map.set("styles",i[e])},t.play=function(){return t.state=1},t.pause=function(){return t.state=0},t.speeding=function(){return t.speed=t.speed%3+1},t.step=function(e){return t.dir=e,t.reset(!0),t.play()},t.state=1,t.speed=3,t.dir=1,t.loaded="loading",t.initData=function(){return n({url:"https://spreadsheets.google.com/feeds/list/1p0DNKBt4oNfDBgHv4ZXH-vu0bJ_PtxFFXCL7o4O_Cxo/1/public/values?alt=json",method:"GET"}).success(function(e){var n,i;return n=e.feed.entry.map(function(t){var e,a,n,r,i,o,s,l,u;return e=t["gsx$日期"].$t.replace(/[年月]/g,"/"),e=e.replace(/[日]/g,""),a=new Date(e),n=a.getMonth()+1,e=a.getYear()+1900+"/"+(10>n?"0":"")+n,r=/(?:(\d+)死)?(?:(\d+)傷)?(?:(\d+)生還)?/.exec(t["gsx$死傷"].$t),i={die:parseInt(r&&r[1]||0),hurt:parseInt(r&&r[2]||0),live:parseInt(r&&r[3]||0)},i.total=i.die+i.hurt,i.radius=3*parseInt(Math.sqrt(i.total))+10,o=parseFloat(t["gsx$緯度"].$t||0),s=parseFloat(t["gsx$經度"].$t||0),l=(t["gsx$短名"].$t||t["gsx$事件"].$t).trim(),u=new google.maps.LatLng(o,s),r={name:l,dateFull:a,casualty:i,lat:o,lng:s,loc:u,date:e}}),n=n.filter(function(t){return t.lat&&t.lng&&t.casualty.total}),i=function(){var e,r,o,s,l;return e=0,r=!1,o=t.dim.timelineHeight,console.log(o),s=o/3,l=1.33*o,(n[n.length-1].top<=67&&1===t.dir||n[0].top>=65&&-1===t.dir)&&(t.state=0),n.map(function(a){var n,i;return 1===t.state&&(a.top=a.top-4*t.dir),a.top<=67&&a.top>=64&&(e=1),a.top<65&&(a.fadeout=1-(65-a.top)/20,a.fadeout<0&&(a.fadeout=0)),a.top>o&&(a.fadeout=1-(a.top-o)/s),a.opacity=(l-a.top)/l,(n=(i=a.opacity)<1?i:1)>0?n:0,(a.top<-200||a.top>o)&&(a.bubble.state=0,a.circle_opacity=0,a.size=0),1===a.bubble.state&&(a.bubble.state=2,a.circle_opacity=0,a.size=a.casualty.radius*a.rate),!r&&a.top>=64&&(t.current=a,a.first=!0,2!==a.bubble.state&&(a.bubble.state=1,a.circle_opacity=1,a.size=0),r=!0),a}),e?a(i,910-300*t.speed):a(i,40-10*t.speed)},a(i,30),t.events=n,t.reset(),t.map=r.init(o[0],s,l),t.setStyle("green"),t.loaded=""})},t.initData(),t.loaded=""}))}).call(this);(function(){var e;e=angular.module("0media.events"),e.factory("0media.events.map-style",[].concat(function(){return{green:[{featureType:"water",stylers:[{color:"#18bca8"},{saturation:-35},{lightness:68}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#18bc9c"},{saturation:-36},{lightness:10}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#18bc9c"},{lightness:65},{saturation:-22}]},{}],gray:[{featureType:"water",stylers:[{color:"#dddddd"}]},{featureType:"landscape",stylers:[{color:"#bbbbbb"}]},{featureType:"road",stylers:[{color:"#999999"},{weight:.4},{visibility:"simplified"}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi",stylers:[{color:"#aaaaaa"}]},{featureType:"administrative",elementType:"geometry",stylers:[{visibility:"on"},{weight:1.3},{color:"#444444"}]},{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#222222"}]},{featureType:"administrative",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"}]},{}],"default":[{featureType:"water",stylers:[{hue:"#1900ff"},{lightness:-86},{saturation:-80}]},{featureType:"landscape",stylers:[{lightness:-47},{hue:"#dd3d00"},{saturation:-80}]},{featureType:"poi",stylers:[{saturation:-100},{lightness:-30}]},{featureType:"road",stylers:[{weight:.3},{saturation:-48},{lightness:-0},{hue:"#dd4400"}]}]}}))}).call(this);(function(){function n(n,o){var t={}.hasOwnProperty;for(var e in o)t.call(o,e)&&(n[e]=o[e]);return n}var o;o=angular.module("0media.events"),o.factory("0media.events.map",[].concat(function(){return{init:function(o,t,e){var a,r,i,g,s,l;return a={center:new google.maps.LatLng(23.624146,120.320623),zoom:9,minZoom:7,maxZoom:18,mapTypeId:google.maps.MapTypeId.ROADMAP,panControl:!1,scaleControl:!1,mapTypeControl:!1,streetViewControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER}},r=new google.maps.LatLngBounds,i=[[25.471911,119.455903],[21.707318,122.356293]],i.map(function(n){return new google.maps.LatLng(n[0],n[1])}).map(function(n){return r.extend(n)}),g=function(n){return n.getYear()+1900},s=new google.maps.Map(o,a),s.fitBounds(r),google.maps.event.addDomListener(window,"resize",function(){var n,e,a,i,g,l,u,m;return n=[$(o).width(),$(o).height()],e=n[0],a=n[1],s.fitBounds(r),i=s.getBounds(),n=[i.getNorthEast().lat(),i.getSouthWest().lng()],g=n[0],l=n[1],n=[i.getSouthWest().lat(),i.getNorthEast().lng()],u=n[0],m=n[1],t([g,m],[u,l])}),l=n(new google.maps.OverlayView,{ll2p:function(n,o){var t,e;return t=this.getProjection(),e=t.fromLatLngToDivPixel(new google.maps.LatLng(n,o))},onAdd:function(){return e.onAdd(this,this.getPanes().overlayLayer)},draw:function(){return e.draw(this,s)}}),l.setMap(s),s}}}))}).call(this);