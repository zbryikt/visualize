(function(){var t;t=angular.module("0media.events",[]),t.controller("0media.events.main",["$scope","$interval","$timeout","$http","0media.events.map"].concat(function(t,e,a,n,r){var o,u;return o=function(e,a){return t.$apply(function(){var n,r,o;return n=[$("#mainmap").width(),$("#mainmap").height()],r=n[0],o=n[1],t.events.map(function(t){return t.y=parseInt((t.lat-e[0])/(a[0]-e[0])*o),t.x=parseInt((t.lng-e[1])/(a[1]-e[1])*r)})})},u={onAdd:function(t,e){var a;return a=document.getElementById("bubbles"),a.parentNode.removeChild(a),e.appendChild(a)},draw:function(e,a){var n;return n=1<<a.getZoom()-7,t.events.map(function(t){var a;return t.x=(a=e.ll2p(t.lat,t.lng)).x,t.y=a.y,t.rate=n})}},t.reset=function(){return t.events.map(function(t,e){return t.fadeout=1,t.opacity=1,t.top=65,t.size=0,t.circle_opacity=0,t.bubble={},t.top=50*e+65,t})},t.play=function(){return t.state=1},t.pause=function(){return t.state=0},t.speeding=function(){return t.speed=t.speed%3+1},t.state=1,t.speed=3,t.initData=function(){return n({url:"https://spreadsheets.google.com/feeds/list/1p0DNKBt4oNfDBgHv4ZXH-vu0bJ_PtxFFXCL7o4O_Cxo/1/public/values?alt=json",method:"GET"}).success(function(e){var n,i;return n=e.feed.entry.map(function(t){var e,a,n,r,o,u,i,s,p;return e=t["gsx$日期"].$t.replace(/[年月]/g,"/"),e=e.replace(/[日]/g,""),a=new Date(e),n=a.getMonth()+1,e=a.getYear()+1900+"/"+(10>n?"0":"")+n,r=/(?:(\d+)死)?(?:(\d+)傷)?(?:(\d+)生還)?/.exec(t["gsx$死傷"].$t),o={die:parseInt(r&&r[1]||0),hurt:parseInt(r&&r[2]||0),live:parseInt(r&&r[3]||0)},o.total=o.die+o.hurt,o.radius=3*parseInt(Math.sqrt(o.total))+10,u=parseFloat(t["gsx$緯度"].$t||0),i=parseFloat(t["gsx$經度"].$t||0),s=(t["gsx$短名"].$t||t["gsx$事件"].$t).trim(),p=new google.maps.LatLng(u,i),r={name:s,dateFull:a,casualty:o,lat:u,lng:i,loc:p,date:e},r.fadeout=1,r.opacity=1,r.top=65,r.size=0,r.circle_opacity=0,r.bubble={},r}),n=n.filter(function(t){return t.lat&&t.lng&&t.casualty.total}),n.map(function(t,e){return t.top=50*e+65}),i=function(){var e,r;return e=0,r=!1,n[n.length-1].top<=67&&(t.state=0),n.map(function(a){var n,o;return 1===t.state&&(a.top=a.top-4),a.top<=67&&a.top>=64&&(e=1),a.top<65&&(a.fadeout=1-(65-a.top)/20,a.fadeout<0&&(a.fadeout=0)),a.top>300&&(a.fadeout=1-(a.top-300)/100),a.opacity=(400-a.top)/400,(n=(o=a.opacity)<1?o:1)>0?n:0,a.top<-200&&(a.bubble.state=0,a.circle_opacity=0,a.size=0),1===a.bubble.state&&(a.bubble.state=2,a.circle_opacity=0,a.size=a.casualty.radius*a.rate),!r&&a.top>=64&&(t.current=a,a.first=!0,2!==a.bubble.state&&(a.bubble.state=1,a.circle_opacity=1,a.size=0),r=!0),a}),e?a(i,910-300*t.speed):a(i,40-10*t.speed)},a(i,30),t.events=n,r.init(o,u)})},t.initData()}))}).call(this);(function(){function t(t,e){var n={}.hasOwnProperty;for(var o in e)n.call(e,o)&&(t[o]=e[o]);return t}var e;e=angular.module("0media.events"),e.factory("0media.events.map",[].concat(function(){return{init:function(e,n){var o,a,r,s,i,l,g;return o={center:new google.maps.LatLng(23.624146,120.320623),zoom:9,minZoom:7,maxZoom:18,mapTypeId:google.maps.MapTypeId.ROADMAP,panControl:!1,scaleControl:!1,mapTypeControl:!1,streetviewControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER}},a=new google.maps.LatLngBounds,r=[[25.471911,119.455903],[21.707318,122.356293]],r.map(function(t){return new google.maps.LatLng(t[0],t[1])}).map(function(t){return a.extend(t)}),s=function(t){return t.getYear()+1900},i=[{featureType:"water",stylers:[{hue:"#1900ff"},{lightness:-86},{saturation:-80}]},{featureType:"landscape",stylers:[{lightness:-47},{hue:"#dd3d00"},{saturation:-80}]},{featureType:"poi",stylers:[{saturation:-100},{lightness:-30}]},{featureType:"road",stylers:[{weight:.3},{saturation:-48},{lightness:-0},{hue:"#dd4400"}]}],l=new google.maps.Map(document.getElementById("mainmap"),o),l.set("styles",i),l.fitBounds(a),google.maps.event.addDomListener(window,"resize",function(){var t,e,n,o,r,s,i,g;return t=[$("#mainmap").width(),$("#mainmap").height()],e=t[0],n=t[1],l.fitBounds(a),o=l.getBounds(),t=[o.getNorthEast().lat(),o.getSouthWest().lng()],r=t[0],s=t[1],t=[o.getSouthWest().lat(),o.getNorthEast().lng()],i=t[0],g=t[1],t}),g=t(new google.maps.OverlayView,{ll2p:function(t,e){var n,o;return n=this.getProjection(),o=n.fromLatLngToDivPixel(new google.maps.LatLng(t,e))},onAdd:function(){return n.onAdd(this,this.getPanes().overlayLayer)},draw:function(){return n.draw(this,l)}}),g.setMap(l),l}}}))}).call(this);