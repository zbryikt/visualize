var m,mi,ref$,w,h,main,hannah,loadPx,config,ret;m=[20,20,30,40],mi=[10,10,20,20],ref$=[900,600],w=ref$[0],h=ref$[1],main=function(t){return t.cat={x:1,y:1},t.idx={x:1,y:1},t.area={x:1,y:1},t.statCat=statCat,t.statIdx=statIdx,t.statArea=statArea,t.gotolink=function(){var a,n;return a=t,n=window.location.pathname,window.location.href=n+"?"+parseInt(1e4*Math.random())+"#"+a.cat.x+"."+a.idx.x+"."+a.area.x+"."+a.cat.y+"."+a.idx.y+"."+a.area.y}},hannah=function(t,a){var n,e,r,i,d,o,c,s,l,x,m;for(e=[],r=0,d=(i=t.range).length;d>r;++r)o=r,c=i[r],e.push({x:t.data[o],y:a.data[o],v:~~c});for(n=e,e=[],r=1,l=n.length;l>r;++r)o=r,i=[n[o-1],n[o]],x=i[0],m=i[1],e.push({v:x.v,src:{x:x.x,y:x.y},des:{x:m.x,y:m.y}});return s=e,{nodes:n,links:s}},loadPx=function(t,a,n){var e,r,i,d,o,c,s,l,x;return e=new Px(t),r=e.metadata.VALUES["指標"],i=e.metadata.VALUES["期間"],d=e.metadata.VALUES["縣市"],o=a*i.length*d.length,c=s={data:function(){var t,a,r,c=[];for(t=0,r=(a=i).length;r>t;++t)l=t,x=a[t],c.push(parseFloat(e.data[o+l*d.length+n])||0);return c}(),local:d[n],index:r[a],range:i},c.min=d3.min(s.data),c.max=d3.max(s.data),c.size=s.max-s.min,s},config={d1:{path:3,idx:2,loc:3},d2:{path:13,idx:0,loc:3}},console.log(JSON.stringify(config)),ret=/#(\d+)\.(\d+)\.(\d+)\.(\d+)\.(\d+)\.(\d+)$/.exec(window.location.href),ret&&(config.d1={path:~~ret[1],idx:~~ret[2],loc:~~ret[3]},config.d2={path:~~ret[4],idx:~~ret[5],loc:~~ret[6]}),$.ajax("data/"+config.d1.path+".px").done(function(t){return $.ajax("data/"+config.d2.path+".px").done(function(a){var n,e,r,i,d,o,c,s,l,x,p,u,f,g,y;return n=loadPx(t,config.d1.idx,config.d1.loc),e=loadPx(a,config.d2.idx,config.d2.loc),r=d3.scale.linear().domain([n.min,n.max]).range([m[3]+mi[3],w-m[1]-m[3]-mi[1]-mi[3]]),i=d3.scale.linear().domain([e.min,e.max]).range([h-m[0]-m[2]-mi[0]-mi[2],m[0]+mi[0]]),d=hannah(n,e),o=d3.select("#label"),o.append("g").attr("class","axis x-axis").append("path").attr("class","base").attr("d",function(){return"M"+m[3]+" "+(h-m[2]-m[0])+"L"+(w-m[3]-m[1])+" "+(h-m[2]-m[0])}),o.append("g").attr("class","axis y-axis").append("path").attr("class","base").attr("d",function(){return"M"+m[3]+" "+m[0]+"L"+m[3]+" "+(h-m[2]-m[0])}),0!==n.size&&0!==e.size?(c=d3.select("#label g.x-axis").selectAll("path.tick").data(function(){var t,a,e,i=[];for(t=n.min,e=n.max,a=n.size/10;0>a?t>=e:e>=t;t+=a)s=t,i.push([r(s),s]);return i}()),l=c.enter().append("g"),l.attr("transform",function(t){return"translate("+t[0]+" "+(h-m[2]-m[0])+")"}),l.append("path").attr("class","tick").attr("d",function(){return"M0 0 L0 5"}),l.append("text").attr("dy","12px").text(function(t){return(t[1]+"").substring(0,4)}),c.exit().remove(),x=d3.select("#label g.y-axis").selectAll("path.tick").data(function(){var t,a,n,r=[];for(t=e.min,n=e.max,a=e.size/10;0>a?t>=n:n>=t;t+=a)s=t,r.push([i(s),s]);return r}()),p=x.enter().append("g"),p.attr("transform",function(t){return"translate("+m[3]+" "+t[0]+")"}),p.append("path").attr("class","tick").attr("d",function(){return"M0 0 L-5 0"}),p.append("text").attr("dy","14px").attr("transform","rotate(90)").text(function(t){return(t[1]+"").substring(0,4)}),x.exit().remove(),d3.select("#label").append("g").attr("transform","translate(5 300)").append("text").attr("transform","rotate(90)").text(function(){return e.local+" / "+e.index}),d3.select("#label").append("g").attr("transform","translate(450 580)").append("text").text(function(){return n.local+" / "+n.index}),u=d3.select("#chart").selectAll("g.link").data(d.links),f=u.enter().append("g"),f.attr("class","link"),f.append("line").attr("x1",function(t){return r(t.src.x)}).attr("y1",function(t){return i(t.src.y)}).attr("x2",function(t){return r(t.des.x)}).attr("y2",function(t){return i(t.des.y)}).attr("stroke",function(t){return t.v<2e3?"#f00":t.v<2008?"#0c0":"#00c"}),u.exit().remove(),g=d3.select("#chart").selectAll("g.node").data(d.nodes),y=g.enter().append("g"),y.attr("class","node"),y.attr("transform",function(t){return"translate("+r(t.x)+", "+i(t.y)+")"}),y.append("circle").attr("r","3px").attr("stroke",function(t){return t.v<2e3?"#f00":t.v<2008?"#0c0":"#00c"}),y.append("text").attr("dy","14px").text(function(t){return t.v+""}),g.exit().remove(),g):void 0})});